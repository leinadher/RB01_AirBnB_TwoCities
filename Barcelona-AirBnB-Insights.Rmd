---
title: "Barcelona Airbnb Insights"
author: "Daniel Herrera & Rodrigo González"
date: "2024-02-10"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
## 1. Presentation of the case

<div style="text-align: center;">
  ![](Assets/Airbnb_Logo_Bélo.svg){width=25%}
</div>

### 1.1. Airbnb

Airbnb, founded in 2008, has grown from a simple idea of renting out air mattresses in a San Francisco apartment to a global phenomenon in the hospitality industry. It has significantly altered the way people travel by offering unique accommodations from local hosts in over 100,000 cities worldwide. Its platform caters to a diverse range of preferences, from single rooms to entire homes, providing more personalized and often more cost-effective lodging options than traditional hotels. This peer-to-peer model has not only democratized travel accommodations but also enabled millions of hosts to generate additional income. As of 2022, Airbnb had hosted over 800 million guest arrivals, showcasing its vast growth and popularity among travelers seeking authentic experiences. This growth trajectory highlights Airbnb's impact on the travel and tourism sector, prompting a reevaluation of traditional hospitality models and regulatory frameworks globally.

---

### 1.2. Airbnb controversies

Airbnb's rise has sparked controversies, especially around its impact on local housing markets, community dynamics, and regulatory compliance. The platform has been criticized for contributing to housing shortages by converting long-term rental properties into short-term tourist accommodations, leading to increased rent and property prices. In cities like Barcelona, this has exacerbated existing tensions between residents and tourists, contributing to over-tourism and altering neighborhood characters. Additionally, Airbnb has faced legal challenges regarding compliance with local housing laws and regulations, with accusations of facilitating illegal rentals. These issues have prompted cities worldwide to implement stricter regulations on short-term rentals, balancing the need for tourism revenue with protecting residents' interests and preserving housing affordability.

Recently, Airbnb has seen a noticeable increase in rental prices, attributed to a combination of factors including heightened demand, limited supply, and the gradual recovery of the travel industry post-pandemic. This surge reflects a broader trend in the accommodation sector where prices are climbing as travelers return in large numbers, seeking unique and safe lodging options. The rise in prices has sparked discussions on affordability and access, urging both Airbnb and hosts to balance profitability with providing value to guests.

---

### 1.3. Airbnb in Barcelona

Airbnb's controversies in Barcelona have been a focal point of discussions about the impact of short-term rentals on cities globally. Barcelona, a prime tourist destination, has faced significant challenges due to the proliferation of Airbnb listings, leading to tensions between the platform, the city's residents, and local authorities.

One major controversy revolves around housing affordability and availability. Critics argue that Airbnb contributes to rising rents and the displacement of long-term residents in favor of short-term tourists. The city has seen protests from local groups and activists who claim that neighborhoods have lost their identity and cohesion due to the influx of tourists staying in Airbnb properties. These concerns have been echoed by housing advocacy groups like the Platform for People Affected by Mortgages (PAH), which has been vocal about the negative impacts of short-term rentals on the local housing market.

The Barcelona City Council, led by Mayor Ada Colau, has taken a firm stance against illegal tourist rentals. Since coming to office in 2015, Colau has introduced strict regulations aimed at curbing the growth of short-term rental platforms like Airbnb. In 2016, the city imposed a moratorium on new tourist licenses and fined Airbnb €600,000 for listing unlicensed properties, highlighting the city's commitment to enforcing its regulations.

Further actions were taken in subsequent years, including the introduction of the PEUAT (Special Urban Plan for Tourist Accommodation) in 2017, which aimed to limit the expansion of tourist accommodations and ensure a balance between tourism and local residents' needs. Despite these measures, conflicts persist, with Airbnb arguing that the city's approach is overly restrictive and harms local hosts who rely on income from short-term rentals.

---

### 1.4. Data sources

Despite the significance of Airbnb data, the private nature of the company, being publicly listed, rules out its open publication. Consequently, an alternative approach is necessary for data collection. In this report, we opt to depend on robust and reliable projects that have already proven their significance in regulating this reservation platform, as well as data sourced directly from the municipality.

We have established two distinct sources of data, the first involves the *Inside Airbnb* project, while the second is taken from the Open Data portal of the Barcelona City Council.

<div style="text-align: center;">
  ![](Assets/InsideAirbnb.png){width=25%}
</div>

#### 1.4.1. Inside Airbnb

The [Inside Airbnb](http://insideairbnb.com/) project is a comprehensive, independent online platform that provides data and analysis on the operations of Airbnb in cities around the world. It was started by activist and data scientist Murray Cox in 2016 as a response to the lack of transparency regarding how Airbnb's business model impacts local housing markets, neighborhoods, and communities. The project aggregates publicly available information on Airbnb listings and reviews to present a more detailed picture of the platform's presence in various cities.

Inside Airbnb has become a crucial resource for researchers, policymakers, journalists, and community groups concerned about the rapid growth of short-term rentals and their effect on cities. By offering detailed data on the number of listings, types of properties, location, pricing, and host information, the project sheds light on how Airbnb contributes to issues like housing affordability, gentrification, and regulatory compliance.

One of the most significant repercussions of the Inside Airbnb project has been its influence on public policy and regulation. Cities like New York, San Francisco, and Barcelona have used data from Inside Airbnb to understand the scale and impact of short-term rentals, leading to the development and enforcement of more stringent short-term rental regulations. For instance, New York City has implemented rules requiring hosts to register with the city, a move aimed at cracking down on illegal listings—a policy informed by insights gained from Inside Airbnb's data.

Inside Airbnb's work has not been without criticism, particularly from Airbnb and hosts who argue that the platform's data might be misinterpreted or used to unjustifiably restrict short-term rentals. Nonetheless, the project's impact in highlighting the need for balance between tourism benefits and community well-being remains undeniable.

In our case we have used the data set of the city of Barcelona through two files, one being the facelifts and the other being the GEOJson of the locations. The quality of the data is indisputable and has been recognized by various actors. Likewise, the update is continuous and we work with data from less than two months ago, these being from mid-December.

We thank Inside Airbnb for its collaboration with consumers and the governments in making this data public, easily reachable and visible.

<div style="text-align: center;">
  ![](Assets/OpenDataBCN.png){width=25%}
</div>

#### 1.4.2. Open data BCN

The portal https://opendata-ajuntament.barcelona.cat/ is an initiative by the Barcelona City Council aimed at promoting transparency, citizen participation, and innovation through open access to public data. This digital platform offers a wide array of datasets on various city aspects such as transportation, environment, demographics, and economy, enabling developers, researchers, and the general public to analyze, create, and share applications that enhance the understanding and management of the city. 

In our case we have used the data set of "Population of Barcelona aggregated by sex according to the Municipal Register of Inhabitants on January 1 of each year". Barcelona City Council offers an easy-to-use API from which we have only indexed the fields of our interest.

We thank Barcelona City Council for its collaboration with citizens and general public for publishing this data of general interest.

https://opendata-ajuntament.barcelona.cat/data/en/dataset/pad_mdbas_sexe/resource/d0e4ec78-e274-4300-a3bc-cb85cf79014d

---


<div style="text-align: center;">
  ![](Assets/OMIC.png){width=25%}
</div>

### 1.5. Municipal Consumer Information Office (OMIC)

The Municipal Consumer Information Office (OMIC) in Barcelona plays a crucial role in protecting consumer rights within the city. This institution provides essential services such as advice, mediation, and conflict resolution between consumers and businesses. Established to ensure that consumer rights are respected and promoted, OMIC offers a valuable resource for citizens facing issues with products or services.

OMIC operates in various areas, including handling complaints and claims, promoting responsible consumption practices, and educating about consumer rights. It also offers workshops and informative talks, contributing to raising awareness and educating consumers about their rights and how to effectively exercise them.

Additionally, OMIC monitors commercial practices within the city to ensure compliance with current consumer legislation. This includes inspecting commercial establishments and implementing corrective actions in cases of infringement. Its work is essential in maintaining a fair balance between consumer interests and those of businesses, promoting a transparent and fair market.

We consider that OMIC is the perfect client for a report that reflects the impact that Airbnb is having on the city of Barcelona. Likewise, and after the major controversies over the price increase that Airbnb has had lately, it is interesting to observe the profile of accommodation and large license holders that Barcelona City Council has had under its sights for years. 

This study is the first phase and after adequate negotiation a second could be launched with much more detailed data.

---

## 2. Data exploration

### 2.1. Data structure

#### 2.1.1 Inside Airbnb

Each entry collected by Inside Airbnb, corresponding to one geographical location or city, is structured unanimously in the following manner:

| Country/City |	File Name |	Description |
| ---------|----------|----------|
| Barcelona	| listings.csv.gz |	Detailed Listings data |
| Barcelona	| calendar.csv.gz |	Detailed Calendar Data |
| Barcelona	| reviews.csv.gz | Detailed Review Data |
| Barcelona |	listings.csv |	Summary information and metrics for listings in (good for visualisations). |
| Barcelona	| reviews.csv |	Summary Review data and Listing ID (to facilitate time based analytics and visualisations linked to a listing). |
| Barcelona	| neighbourhoods.csv |	Neighbourhood list for geo filter. Sourced from city or open source GIS files. |
| Barcelona |	neighbourhoods.geojson |	GeoJSON file of neighbourhoods of the city. |

Given this recurring structure and the richness of the data, the initial goal of the project was to compare data from different European cities. This objective is evident in the code implementation for loading data into data frames, designed to be replicable and applicable to any city's data, provided the files are loaded into the working directory and stored in folders named after the respective cities.
This approach was eventually discarded, as it became clear that focusing on Barcelona as a study case is already in itself an interesting focus.

The data collected from Barcelona corresponds to the 13 of December, 2023.


```{r load_listings, include=FALSE}

setwd("~/GitHub/RB01_AirBnB_TwoCities")

library(ggplot2)
library(ggthemes)
library(tidyr)
library(dplyr)
library(plotly)
library(RColorBrewer)
library(httr)
library(jsonlite)
library(stringr)
library(corrplot)
library(reshape2)
library(readxl)
library(gridExtra)

# For maps:
library(sf)
library(ggmap)
library(leaflet)
library(osmdata)
library(maptiles)    ## for get_tiles() / used instead of OpenStreetMap
library(tidyterra)   ## for geom_spatraster_rgb() - Background tiles

# Set default graphics device to PDF
options(knitr.graphics.format = "svg")

################################################################################

# LOADING CITY AIRBNB DATA
# Read listings.csv files from folder with city name, and save as data frame

# Loading 'listings.csv' files from all city folders:
file_paths <- list.files(pattern = "listings.csv$",
                         recursive = TRUE,
                         full.names = TRUE)

for (file_path in file_paths) {
  # Extract city name from the file path
  city_name <- sub(".*/(\\w+)/listings.csv", "\\1", file_path, perl = TRUE)
  
  # Read CSV file and assign it to a variable with the city name
  assign(city_name, read.csv(file_path))
}

################################################################################

```

The main source of data is the `listings.csv` file, which contains a collection of 18,321 listings with 18 variables:

```{r structure, echo=TRUE}
dim(Barcelona)
str(Barcelona)
```
The interpretation of variables is the following:

- `id`: numerical identifier for each listing
- `name`: name of the listing
- `host_id`: numerical identifier for the host of the listing
- `host_name`: name of the host.
- `neighbourhood`: location information specifying the neighborhood the listing is in
- `neighbourhood_group`: larger district grouping of neighborhoods (simplified from 71 to 10 districts)
- `latitude`: latitude coordinate of the listing
- `longitude`: longitude coordinate of the listing
- `room_type`: categorical string describing the type of room
- `price`: daily price of the listing in the local currency (euro)
- `minimum_nights`: minimum number of nights the listing can be booked
- `number_of_reviews`: number of reviews at the time the data was captured
- `last_review`: date of the latest review for the listing
- `reviews_per_month`: average number of reviews per month for each listing
- `calculated_host_listings_count`: number of listings by the listing host, calculated directly from the data
- `availability_365`: availability of the listing in days starting from the data capture day within the next year
- `number_of_reviews_ltm`: number of reviews in the past 12 months
- `license`: compliance with City Council; includes the license ID number if available, otherwise, pending or empty


#### 2.1.2. Open data BCN

As explained previously, the data from has been enriched with official demographic information obtained via API from the Open Data BCN project from the City Council. The topic of choice was “Population of Barcelona aggregated by sex according to the Municipal Register of Inhabitants on January 1 of each year”, found in the file `2023_pad_mdbas_sexe.csv`, from which the population grouped by neighbourhood and district was extracted and merged into our main data frame. The indexed fields are:


```{r API, cache=TRUE, include=FALSE}

################################################################################

# API CALL AND DATA MERGE
# 1. We obtain demographics data (2023_pad_mdbas_sexe.csv) via API
# 2. We merge listings.csv with demographics data

# API endpoint
api_url <- "https://opendata-ajuntament.barcelona.cat/data/api/action/datastore_search?resource_id=d0e4ec78-e274-4300-a3bc-cb85cf79014d&limit=3000"

# Sending a GET request to the API and check for success
response <- GET(api_url) %>% stop_for_status()

# Extracting content from the response
data <- fromJSON(content(response, "text"), flatten = TRUE)

# The actual data is usually in a specific part of the JSON
# Adjust the following line according to the structure of the JSON response
demographics <- data$result$records[c("Nom_Districte", "Nom_Barri", "Valor")]

# Viewing the first few rows of the dataframe
head(demographics)

# Group by neighborhood, convert 'Valor' to numeric, and sum values
demographics_grouped <- demographics %>%
  group_by(Nom_Barri) %>%
  mutate(Valor = as.numeric(Valor)) %>%  # Convert 'Valor' column to numeric
  summarise(Total_Population = sum(Valor))

# Merge the datasets
Barcelona_md <- left_join(Barcelona, demographics_grouped, by = 
                           c("neighbourhood" = "Nom_Barri"))

```

- `Nom_Districte`: name of the greater district
- `Nom_Barri`: name of the neighbourhood
- `Valor`: population count

The merge has been done for `neighbourhood = Nom_Barri`, resulting in a new `demographics` column in our `Barcelona_md` data frame (md for merged).

---

### 2.2. Further data enrichment

From a first assessment of the data it was observed that within it, additional numerical and categorical variables could be extracted and used to provide insightful details once plotted.


#### 2.2.1. Star rating

The `name` field was found to include among other information the star rating from 0 to 5 preceded by a star character, a pattern easily reproducible with regular expressions. With pipes and filters it has been extracted as a numerical value and introduced as an additional column. Cases where names do not contain a star rating are listed as NA.


#### 2.2.2. License status

String items found under `license` were observed to either contain a license ID matching the City Council's figure HUTB (Habitatge d'Ús Turístic de Barcelona), the word 'Exempt', or be missing at all. A new variable `LicenseGrouping` was established to contain three new categories: `Exempt`, `License is displayed` and `License is not displayed`.


#### 2.2.3. Large and small tenants

By considering the variable `calculated_host_listings_count` and referencing the [Spanish Housing Law of 12/2023](https://www.boe.es/buscar/act.php?id=BOE-A-2023-12203), which outlines the differentiation between small and large tenants when there are 5 or more properties involved, a new categorical variable, `TenantSizeGrouping`, was established to capture this observation.

```{r enrichment, include=FALSE, cache=TRUE}

################################################################################

# EXTRACT STAR-RATING FROM NAME, AND ADD AS COLUMN TO DATA FRAME

extract_star_rating <- function(name) {
  matches <- str_extract(name, "★([0-9.]+)")
  as.numeric(gsub("★", "", matches))
}

Barcelona_md$star_rating <- sapply(Barcelona_md$name, extract_star_rating)

head(Barcelona_md[c("name", "star_rating")], 5)

################################################################################

# EXTRACT LICENSE STATUS
# Save to a new column 'LicenseGrouping'

Barcelona_md <- Barcelona_md %>%
  mutate(LicenseGrouping = case_when(
    grepl("Exempt", license, ignore.case = TRUE) ~ "Exempt",
    license != "" & !is.na(license) ~ "License is displayed",
    TRUE ~ "License is not displayed"
  ))

print(Barcelona_md)

################################################################################

# GROUP LARGE TENANTS AND SMALL TENANTS

Barcelona_md <- Barcelona_md %>%
  mutate(TenantSizeGrouping = case_when(
    calculated_host_listings_count >= 5 ~ "Large tenant",
    calculated_host_listings_count <= 4 ~ "Small tenant",
    TRUE ~ NA_character_ # This handles any unexpected cases, such as missing values
  ))

# View the first few rows of the transformed dataset to verify the changes
head(Barcelona_md)

################################################################################

# HOST COUNT: LARGE TENANTS AND SMALL TENANTS

# Create a new data frame named tenants
tenants <- Barcelona_md %>%
  group_by(host_id) %>%
  summarise(listing_count = n())

tenants <- tenants %>%
  mutate(TenantSizeGrouping = case_when(
    listing_count >= 5 ~ "Large tenant",
    listing_count <= 4 ~ "Small tenant",
    TRUE ~ NA_character_ # This handles any unexpected cases, such as missing values
  ))

################################################################################

# FILTER OUT WRONG OUTLIERS
# Specifically, a listing valued at about €60,000 per night,
# which is missing other information fields, and distorts further plots.
# This was a team-agreed decision to provide cleaner results.

Barcelona_md <- filter(Barcelona_md, is.na(price) | price < 50000)

################################################################################

```

---

### 2.3. Visualizations

#### 2.3.1. Airbnb listings map overview

```{r plot1, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, results='hide', fig.keep='all', fig.width=10, fig.height=10, fig.align='center', cache=TRUE}

# Load API key. UPDATE WHEN EXPIRED!
register_stadiamaps("8df95c0b-0133-4440-b3f0-c1c6e2f26844", write = TRUE)

# Load GeoJSON file and convert to sf object
geojson_BCN <- sf::st_read("Data/Barcelona/neighbourhoods.geojson")

# Create bounding box limits, map and merge geojson with Barcelona_md
bbox.limits <- sf::st_bbox(geojson_BCN)
map_BCN <- get_stadiamap(getbb("Barcelona"), maptype = "stamen_toner_lite", zoom = 13)

merged_data <- merge(geojson_BCN, Barcelona_md, by = "neighbourhood", all.x = TRUE)

# Plot map
ggmap(map_BCN) +
    geom_sf(data = merged_data,
          inherit.aes = FALSE,
          aes(fill = price.y, label = neighbourhood),
          fill = "white",
          alpha = 0,
          color = "#f1796f",
          linewidth = 0.5) +
  geom_point(data = Barcelona_md, 
             aes(x = longitude, y = latitude), 
             color = "#f1796f",
             alpha = 0.2,
             size = 0.4) +
  labs(title = "Airbnb listings overview",
       subtitle = "Barcelona",
       x = "Longitude",
       y = "Latitude")

```

A straightforward visualization of the dataset's listings already reveals diverse concentrations, aligning with popular tourist and overnight stay destinations in Barcelona. The primary cluster is situated in the expansive neighborhood of *Eixample* and *Ciutat Vella*, along with *Gràcia*, and the vicinity encompassing the main train station of *Sants* and *Montjuïc*. The density significantly diminishes beyond these central regions. It is essential to acknowledge that the recorded data corresponds to the official district divisions of Barcelona, delineated by their boundaries. It is plausible that additional clusters of listings may exist outside these demarcations. For instance, areas like the proximity of the airport in the southwestern town of *El Prat de Llobregat* might host distinct clusters. Incorporating such regions into future studies could uncover valuable insights in this regard.

---

#### 2.3.2. Airbnb listings by neighbourhood group

```{r plot2, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, results='hide', fig.keep='all', fig.width=8, fig.height=4, fig.align='center'}

listings_count <- Barcelona_md %>%
  group_by(neighbourhood_group) %>%
  summarise(number_of_listings = n()) %>%
  arrange(number_of_listings)  # Ascending order

ggplot(listings_count, aes(x = reorder(neighbourhood_group,
                                       number_of_listings),
                           y = number_of_listings,
                           fill = neighbourhood_group)) +
  geom_bar(stat = "identity",
           color = NA,
           show.legend = FALSE) +
  scale_fill_manual(values = rep("#f1796f",
                                 length(unique(listings_count$neighbourhood_group)))) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45,
                                   hjust = 1)) +
  labs(x = "Neihgbourhood group",
       y = "Number of listings",
       title = "Airbnb listings by neighbourhood group",
       subtitle = "Barcelona") +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  scale_y_continuous(breaks = seq(0, max(listings_count$number_of_listings), by = 1000))

```

This bar chart illustrates the number of Airbnb listings across different neighbourhoods in Barcelona. The most prominent feature is the overwhelming dominance of the *Eixample* neighbourhood, with the number of listings towering over other areas. This suggests *Eixample* is a highly sought-after area for tourists or visitors using Airbnb. In contrast, neighbourhoods like *Nou Barris* and *Sant Andreu* have far fewer listings, which may indicate less tourist activity or a lower availability of rental properties on Airbnb. 

The distribution indicates a potential disparity in the spread of tourism across the city, with certain areas possibly facing higher pressure from tourist accommodation. It is very interesting to note that only considering *Eixample* the number of listings is greater than the sum of the last six neighborhoods. This could have implications for local housing markets, infrastructure demand, and urban planning. The chart effectively highlights the disparities and could serve as a basis for more detailed analysis on the impact of short-term rentals on the urban landscape of Barcelona. As mentioned, there are several areas that do not reach a few hundred listings, which indicates a very low concentration of Airbnbs in relation to the people who reside there.

---

#### 2.3.3. Airbnb listings per 100 residents by neighbourhood group

```{r plot3, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, results='hide', fig.keep='all', fig.width=8, fig.height=4, fig.align='center'}

# Group by neighbourhood and count
data_grouped <- Barcelona_md %>%
  group_by(neighbourhood_group) %>%
  summarise(count = n())

# Group total population by neighbourhood group
unique_population_per_neighbourhood_group <- Barcelona_md %>%
  select(neighbourhood_group, Total_Population) %>%
  distinct() %>%
  filter(!is.na(Total_Population)) %>%
  group_by(neighbourhood_group) %>%
  summarise(Total_Population = sum(Total_Population))

data_grouped_with_population <- left_join(data_grouped, 
                                          unique_population_per_neighbourhood_group,
                                          by = "neighbourhood_group")

data_grouped_with_population$proportion <- data_grouped_with_population$count / data_grouped_with_population$Total_Population
data_grouped_with_population$proportion_percent <- data_grouped_with_population$proportion * 100

# Barplot in ggplot2 as percentages
ggplot(data_grouped_with_population, aes(x = reorder(neighbourhood_group, proportion_percent), y = proportion_percent)) +
  geom_bar(stat = "identity", fill = "#f1796f") +
  theme_minimal() +
  labs(title = "Airbnb listings per 100 residents by neighbourhood group",
       subtitle = "Barcelona",
       x = "Neighbourhood group",
       y = "Percentage (%)") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

The data presented in this bar graph serves as an insightful complement to the previous visualization. By comparing the number of listings in each neighbourhood group with the official demographics corresponding to that district, a proportion of Airbnb listings per person can be obtained. This better reflects the different densities of listings between parts of the city. Although *Eixample* and *Ciutat Vella* still reign as the most listing-saturated districts, the higher concentration of *Ciutat Vella* compared to *Eixample* becomes obvious. This is explained by many factors, such as the higher urban density of the Old City and the resulting higher concentration of population by area, and also *Eixample* being a rather large district within Barcelona. Similar observations can be made between the other neighbourhood groups.

According to the [Government of Catalonia](https://web.gencat.cat/es/actualitat/detall/Regulacio-de-pisos-turistics-per-garantir-lacces-a-lhabitatge), areas with more than 5 tourist housing listings per 100 inhabitants face housing access issues. A recent Decree Law has set this limit to address the problem, with city councils having the authority to permit up to 10 through their urban planning. It is important to note that our study focuses exclusively on Airbnb listings, and other units may be legally listed as tourist accommodations on different platforms.

---

#### 2.3.4. Room type count

```{r plot4, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, results='hide', fig.keep='all', fig.width=8, fig.height=4, fig.align='center'}

# Summarize the data to count the number of each property type
property_counts <- Barcelona_md %>%
  group_by(room_type) %>%
  summarise(quantity = n())

# Create the bar plot
ggplot(property_counts, 
       aes(x = reorder(room_type, quantity), 
           y = quantity, 
           fill = 'red')) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = quantity), 
            hjust = 0, 
            size = 3) +
  labs(x = "", 
       y = "Count", 
       title = "Room type count",
       subtitle = "Barcelona") +
  coord_flip() + # Flip the plot to horizontal bars
  guides(fill = FALSE) +  # Remove the legend
  theme_minimal()

```

There are four categories of room types displayed: `Entire home/apt`, `Private room`, `Shared room`, and `Hotel room`.

The `Entire home/apt` category has the highest count, surpassing the 10,000 mark, suggesting that entire apartments or homes are the most common type of property listed in Barcelona. The `Private room` category follows, with roughly half as many listings as entire homes, indicating a significant presence in the market but less than the full property rentals.

`Shared rooms` and `Hotel rooms` have significantly fewer listings compared to the other two categories. Shared rooms barely register on the scale, suggesting they are a less popular option among the listings. Hotel rooms have the smallest count, indicating that traditional hotel stays are much less commonly listed on platforms likely compared to short-term rental options.

The visual emphasizes the prevalence of whole property rentals in Barcelona's accommodation offerings, with a substantial secondary market for private rooms. The minimal presence of shared and hotel room listings could reflect market demand or possibly restrictions and regulations within the city.

---

#### 2.3.5. Acommodation type by neighbourhood group

```{r plot5, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, results='hide', fig.keep='all', fig.width=10, fig.height=10, fig.align='center'}

ggplot(Barcelona_md, aes(x = neighbourhood_group)) + 
  geom_bar(aes(fill = room_type), position = "dodge") +
  facet_wrap(~ room_type, scales = "free_y", nrow = 2) +
  theme_minimal() +
  labs(title = "Acommodation type by neighbourhood group",
       subtitle = "Barcelona",
       x = "Neighbourhood group",
       y = "Count") +
    theme_minimal() +
  theme(axis.text.x = element_text(size = 8, angle = 45, hjust = 1))

```

This chart provides a detailed breakdown of Airbnb listings in Barcelona by room type and neighbourhood group, with four distinct categories of accommodation: `entire home/apt`, `hotel room`, `private room`, and `shared room`. The y-axis represents the number of listings, which is not consistent across the categories, indicating the use of a free scale within the facets to better display the range of data.

- Focusing first on the `Entire home/apt` category, we observe a pronounced peak in *Eixample*, with over 4,000 listings, which significantly overshadows the counts in other areas, where the second-highest listing *Ciutat Vella* has just above 1,000. This indicates a heavy concentration of full-property rentals in that particular part of the city, which shows that *Eixample* is a popular central area known for tourist attractions.

- The `Hotel room` category exhibits a very different scale, peaking at around 80 listings in the most prominent neighbourhood, being again *Eixample* for this category. This suggests that hotel rooms are a minor part of the Airbnb market in Barcelona or that hotels prefer to use other channels for renting out rooms. There are several neighborhoods that do not even present a single hotel listing.

- For `Private rooms`, the distribution seems more even, yet *Eixample* stands out with nearly 2,000 listings, which is about triple the number of listings in the second next populous neighborhood in this category, *Sants-Montjuïc*. The shape of the graph is surprisingly similar to the `Entire home/apt`.

- The `Shared room` type displays the least number of listings across neighborhoods, with the highest being under 80. The low count could indicate that shared rooms are not a preferred choice for visitors to Barcelona, or such listings are rare.

The vast discrepancy between the number of `Entire home/apt` listings and other types suggests that visitors to Barcelona may prefer the privacy and space of an entire apartment. The data could also imply a potential regulatory environment that either supports whole-home rentals or one that has yet to address this preference in the sharing economy.

The chart is an excellent tool for stakeholders to assess market saturation in various neighborhoods and room types. For investors and property managers, areas with lower counts could represent potential growth opportunities. Conversely, neighborhoods with high listings might face more competition, affecting pricing strategies. For policymakers such as OMIC and the Barcelona City hall, such data can be crucial in understanding how short-term rentals are distributed across the city and may guide decisions on tourism management, zoning, and housing policies to balance the needs of residents and visitors.

---

#### 2.3.6. License status

```{r plot6, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, results='hide', fig.keep='all', fig.width=8, fig.height=4, fig.align='center'}

license_count <- Barcelona_md %>%
  group_by(LicenseGrouping) %>%
  summarise(quantity = n())

# Create the bar plot
ggplot(license_count, 
       aes(x = reorder(LicenseGrouping, quantity), 
           y = quantity, 
           fill = 'red')) +
  geom_bar(stat = "identity") +
  labs(x = "",
       y = "Count", 
       title = "License status",
       subtitle = "Barcelona") +
  geom_text(aes(label = quantity), 
            hjust = 0, 
            size = 3) +
  theme_minimal() +
  coord_flip() + # Flip the plot to horizontal bars
  guides(fill = FALSE)  # Remove the legend

```
This visualization provides a rough insight into the licensing status of listings. According to the law, full-home listings require a registration and a license number. Instances under the `License not displayed` group may either be listed illegally or have their license approval pending. `Exempt` could mean a listing only includes part of a housing unit or a room, and thus does not have to be legally registered as full touristic housing. It would be valuable to observe the evolution of the `License is displayed` group over time, to evaluate whether the city's efforts to regulate touristic housing have any effectiveness.

---

#### 2.3.7. Large vs. small tenants

```{r plot7, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, results='hide', fig.keep='all', fig.width=8, fig.height=6, fig.align='center'}

tenant_count <- tenants %>%
  group_by(TenantSizeGrouping) %>%
  summarise(listing_count = n())

# Host numbers: great vs. small tenants
plotA <- ggplot(tenant_count, 
       aes(x = TenantSizeGrouping, 
           y = listing_count, 
           fill = "red")) +
  geom_bar(stat = "identity") +
  labs(x = "",
       y = "Host count", 
       title = "Large vs. small tenants - Host count",
       subtitle = "Barcelona") +
  geom_text(aes(label = listing_count), 
            hjust = 0, 
            size = 3) +
  theme_minimal() +
  coord_flip() + # Flip the plot to horizontal bars
  guides(fill = FALSE)  # Remove the legend

# Listing numbers: great vs. small tenants

tenant_count <- Barcelona_md %>%
  group_by(TenantSizeGrouping) %>%
  summarise(quantity = n())


plotB <- ggplot(tenant_count, 
       aes(x = TenantSizeGrouping, 
           y = quantity, 
           fill = 'red')) +
  geom_bar(stat = "identity") +
  labs(x = "",
       y = "Listing Count", 
       title = "Large vs. small tenants - Listing count",
       subtitle = "Barcelona") +
  geom_text(aes(label = quantity),
            hjust = 0, 
            size = 3) +
  theme_minimal() +
  coord_flip() + # Flip the plot to horizontal bars
  guides(fill = FALSE)  # Remove the legend

grid.arrange(plotA, plotB, ncol = 1)

```

This set of charts looks at two host categories: `Small tenant` and `Large tenant`, based on the number of listings they possess. Given the context of rental tension zones, a [recent legislation](https://www.boe.es/buscar/act.php?id=BOE-A-2023-12203) changed the definition of a large property owner from 10 to 5 properties. This meant that several former small tenants now qualify as large tenants, potentially altering the market dynamics and affecting the application of policies within stressed areas.

In the first plot, the count of `Small tenant` vastly outnumbers `Large tenant`, indicating a much higher proportion of landlords with fewer properties. This however is reflected otherwise when looking at the overall `Listing count` in the second plot, which shows a very close match between number of listings that are registered by `Small tenant` and `Large tenant`.

From this observation we can conclude that, although much fewer in number, large tenants represent the majority of the overall market. It is also worth noting that the presence of more small tenants could reflect a diverse range of property offerings, from single rooms to entire apartments, which may cater to different segments of the population. This might have a stabilizing effect on rental prices, as a diverse supply can meet varied demand. However, if small tenants begin to consolidate or if their listings push housing costs above the 30% income threshold, it could lead to increased regulatory scrutiny.

Regarding the law's stipulations, if the large tenants' listings are concentrated in areas where housing costs exceed 30% of household income or where rental prices have outpaced CPI by more than 3 percentage points, these areas could be designated as rental tension zones. This would trigger regulatory measures that could include rent capping or other controls to protect tenants.

---

#### 2.3.8. Number of hosts per listing count

```{r plot8, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, results='hide', fig.keep='all', fig.width=8, fig.height=4, fig.align='center'}

listings_per_host <- Barcelona_md %>%
  group_by(host_id) %>%
  summarize(count = n(), .groups = 'drop') %>%
  filter(!is.na(host_id))

# Group all counts of 10 or more into '10+'
listings_per_host$count_grouped <- ifelse(listings_per_host$count > 10,
                                          "10+",
                                          as.character(listings_per_host$count))

# Convert the column to a factor to control the order in the plot
listings_per_host$count_grouped <- factor(listings_per_host$count_grouped,
                                          levels = c(as.character(1:10), 
                                                     "10+"))

# Create the histogram
ggplot(listings_per_host, aes(x = count_grouped)) +
  geom_bar(fill = "#f1796f") +
  labs(x = "Listing count",
       y = "Number of hosts",
       title = "Number of hosts per listing count",
       subtitle = "Barcelona") +
  theme(axis.text.x = element_text()) +
  theme_minimal()

```

The above plot illustrates another defining observation, by sorting all Airbnb hosts according to the number of listings they have registered on the platform. Represented in the variable `Number of hosts`, out of a total of 7,015 hosts, an overwhelming majority is responsible for only one listing, with a quick decrease in number as the `Listing count` increases

It becomes obvious that the market is overwhelmingly populated by 1-property hosts, suggesting a high level of competitiveness and relatively low monopoly of the market

---

#### 2.3.9. Top 5 hosts by number of listings

```{r plot9, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, results='hide', fig.keep='all', fig.width=8, fig.height=4, fig.align='center'}

top_hosts <- Barcelona_md %>%
  distinct(host_id, .keep_all = TRUE) %>%
  arrange(desc(calculated_host_listings_count)) %>%
  slice_head(n = 5)

# Create the ggplot2 horizontal barplot
ggplot(top_hosts, aes(x = reorder(host_name, calculated_host_listings_count),
                      y = calculated_host_listings_count)) +
  geom_bar(stat = "identity",
           fill = "#f1796f") +
  geom_text(aes(label = calculated_host_listings_count), 
            hjust = 0, 
            color = "black",
            size = 3) +
  labs(title = "Top 5 hosts by number of listings",
       subtitle = "Barcelona",
       x = "",
       y = "Listing count") +
  coord_flip() + # Flip the plot to horizontal bars
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 0, hjust = 1))

```
To provide further insight into the host number and listing count disparity, by querying through unique items of `host_id`, and sorting based on `calculated_host_listings_count` we can obtain the 5 top hosts by number of listings. A brief look at the graph reveals that each of the five entities is accountable for a significantly greater number of properties than what is deemed as characteristic of large tenants according to the law. Also, the assumption could be made that the names reflect that such hosts are not actual individual human users of the platform, but rather companies or trusts, which operate large touristic housing rental businesses across Barcelona.

---

#### 2.3.10. Average price by neighbourhood

```{r plot10, echo=FALSE, error=FALSE, fig.align='center', fig.height=10, fig.keep='all', fig.width=10, message=FALSE, warning=FALSE, cache=TRUE, results='hide'}

# Calculate the mean price for each neighborhood
mean_price_by_neighbourhood <- aggregate(price ~ neighbourhood, merged_data, mean)
merged_data <- merge(merged_data, mean_price_by_neighbourhood, by = "neighbourhood")

# Plot map
m <- ggmap(map_BCN) +
  geom_sf(data = merged_data,
          inherit.aes = FALSE,
          aes(fill = price.y, text = neighbourhood),
          color = "#f1796f",
          linewidth = 0.3) +
  scale_fill_gradient(low = alpha("white", 0), high = alpha("#f1796f", 1)) +
  theme_minimal() +
  labs(title = "Average price by neighbourhood",
       subtitle = "Barcelona",
       x = "Longitude",
       y = "Latitude") 

m

```

---

#### 2.3.11. Price by neighbourhood group

```{r plot11, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, results='hide', fig.keep='all', fig.width=10, fig.height=8, fig.align='center'}

ggplot(Barcelona_md, aes(x = neighbourhood_group, y = price)) +
  geom_jitter(width = 0.2,
              alpha = 0.25,
              color = "#f1796f") +
  geom_violin(fill = NA) +
  scale_y_log10() +
  labs(title = "Price by neighbourhood group",
       subtitle = "Barcelona",
       x = "Neighbourhood group",
       y = "Price (€)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45))

```

---

#### 2.3.12. Price boxplots by neighbourhood group

```{r plot12, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, results='hide', fig.keep='all', fig.width=10, fig.height=5, fig.align='center'}

ggplot(Barcelona_md, aes(x = neighbourhood_group, y = price)) +
  geom_boxplot(fill = "#c77cff", alpha = 0.4, outlier.color = "#c77cff", color = "#c77cff") +
  scale_y_log10() +
  labs(title = "Price boxplots by neighbourhood group",
       subtitle = "Barcelona",
       x = "Neighbourhood group",
       y = "Price (€)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.7))

```

---

#### 2.3.13. Listings by minimum nights

```{r plot13, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, results='hide', fig.keep='all', fig.width=10, fig.height=5, fig.align='center'}

# Modify the minimum_nights column to create a '35+' category
Barcelona_md$minimum_nights_grouped <- ifelse(Barcelona_md$minimum_nights > 35, 
                                              "35+",
                                              as.character(Barcelona_md$minimum_nights))

# Convert the column to a factor to control the order in the plot
Barcelona_md$minimum_nights_grouped <- factor(Barcelona_md$minimum_nights_grouped,
                                              levels = c(as.character(1:35),
                                                         "35+"))

# Create the histogram
ggplot(Barcelona_md, aes(x = minimum_nights_grouped)) +
  geom_bar(fill = "#f1796f") +
  labs(x = "Minimum nights",
       y = "Count",
       title = "Listings by minimum nights",
       subtitle = "Barcelona") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 0,
                                   vjust = 0.5, 
                                   hjust = 1))

```

---

#### 2.3.14. Minimum nights boxplots by neighbourhood group

```{r plot14, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, results='hide', fig.keep='all', fig.width=10, fig.height=5, fig.align='center'}

ggplot(Barcelona_md, aes(x = neighbourhood_group, y = minimum_nights)) +
  geom_boxplot(fill = "#7cae00", alpha = 0.4, outlier.color = "#7cae00", color = "#7cae00") +
  scale_y_log10() + # Otherwise boxplot conveys no information
  labs(title = "Minimum nights boxplots by neighbourhood group",
       subtitle = "Barcelona",
       x = "Neighbourhood group",
       y = "Minimum nights") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.7))

```

---

#### 2.3.15. Reviews boxplots by neighbourhood group

```{r plot15, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, results='hide', fig.keep='all', fig.width=10, fig.height=5, fig.align='center'}

ggplot(Barcelona_md, aes(x = neighbourhood_group, y = number_of_reviews)) +
  geom_boxplot(fill = "#00bfc4", alpha = 0.4, outlier.color = "#00bfc4", color = "#00bfc4") +
  coord_cartesian(ylim = c(0, 200)) + 
  labs(title = "Reviews boxplots by neighbourhood group",
       subtitle = "Barcelona",
       x = "Neighbourhood group",
       y = "Review count") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.7))

```

---

#### 2.3.16. Correlation of numerical values

``` {r plot16, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, results='hide', fig.keep='all', fig.width=8, fig.height=8, fig.align='center'}

numeric_data <- Barcelona_md[, sapply(Barcelona_md, is.numeric)]
numeric_data <- numeric_data[, !colnames(numeric_data) %in% c('host_id',
                                                              'id',
                                                              'latitude',
                                                              'longitude', 
                                                              'number_of_reviews_ltm')]

# Compute correlation matrix
cor_matrix <- cor(numeric_data, use = "pairwise.complete.obs")

# Convert correlation matrix to long format for ggplot
cor_df <- as.data.frame(as.table(cor_matrix))
names(cor_df) <- c("Var1", "Var2", "Correlation")

ggplot(cor_df, aes(Var1, Var2)) +
  geom_point(aes(fill = Correlation), size = 12, shape = 21, color = "white") +
  scale_size_continuous(guide = "none") +  # Remove size legend
  scale_fill_gradient(low = "white", high = "#f1796f") +
  labs(title = "Correlation of numerical values",
       subtitle = "Barcelona",
       x = "",
       y = "") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        plot.margin = unit(c(0, 0, 2, 0), "lines"))

```

---

#### 2.3.17. Price by star rating

```{r plot17, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, results='hide', fig.keep='all', fig.width=10, fig.height=5, fig.align='center'}

ggplot(Barcelona_md, aes(x = star_rating, y = price)) +
  geom_point(width = 0.1,
             alpha = 0.4) + # Plot the points
  geom_smooth(method = "lm", color = "#f1796f") + # Add linear model line
  labs(title = "Price by star rating",
       subtitle = "Barcelona",
       x = "Star rating",
       y = "Price (€)") +
  theme_minimal()

```

---

## 3. Additional chapter

An additional segment of the project worthy of mention are the alternative workflows and R packages that we explored, discarded or eventually implemented into our work.

One notable case was opur strategy for accessing the Open Data BCN demographics data set, which relied on the Barcelona City Council's API. We opted for this path with the sole purpose of exploring alternative data loading workflows, despite the straightforward alternative of downloading and loading the `2023_pad_mdbas_sexe.csv` file from the website being more easily available.

Amongst other libraries that weren't covered during the Bootcamp, we incorporated the `gridExtra` library to manipulate the `ggplot2` layout, allowing for efficient division and arrangement of layouts to optimize visualization.

We also experimented with various libraries, which can be seen loaded yet unused in the R code, such as `plotly`, `RColorBrewer`, `jsonlite`, `reshape2`, `leaflet`, and `tidyterra.` However, practical challenges prompted the exclusion of certain libraries. A notable case is the implementation of `plotly` for interactive map creation, which proved problematic when confronted with large-sized map tiles, resulting in performance issues and unwieldy HTML file sizes. Consequently, a decision was made to shift to conventional PNG images to mitigate these challenges and ensure a more and resource-efficient workflow. This iterative process underscores the importance of a judicious and technically sound approach to library selection and implementation in data visualization workflows.

As a secondary additional chapter of the project we opted for a GitHub-based workflow, which was a new experience for both of us. This allowed us to collaborate simultaneously from different devices, and ensure the reproducibility of the code, whilst keeping track of changes and version updates.

---

## 4. Conclusion

WRITE A CONCLUSION!

---

## 5. Appendix

### 5.1. Experiences using generative AI tools

Understanding that generative AI tools are here to stay as an invaluable companion of present-day and future programmers, we implemented them as a support and proof-checking tool, easily accelerating our productivity several times over. We observed that while quick in generating syntactically correct R code, it still requires the user to have a correct grasp of the packages being used and general R workflows. Without accurate prompts or careful interpretation of the outputs, AI remains unable to comprehend the full context of the project and address every single question adequately. Fine tuning results and providing additional context of the structure of the data sets turned out to be an essential step in our AI-powered workflow.

We employed ChatGPT versions 3.5 and 4, with the latter incorporating a Data Analyst functionality. This feature was capable amongst other things of interpreting screenshots of sample plot types and returning the corresponding ggplot2 code, or processing the source data in csv format for a better understanding of its structure, its variable names, data types, etc. One noteworthy application was in constructing correct regex patterns, which we would easily be able to express in natural language, but would require more knowledge and time to be written and tested manually. It is worth noting that the AI-generated code suggestions consistently aligned with our knowledge of R packages as well as the scope of the course. They not only facilitated the exploration of solutions but also prompted consideration of additional settings for certain functions that we might have overlooked initially.